[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
üêò Using PostgreSQL database with migration system
[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
üìù Redis temporarily disabled - using in-memory cache for single-server deployment
üõ°Ô∏è Starting Comprehensive Battle System Audit...

üìù Step 1: Setting up Test Data...
‚úÖ Created 3 test characters.
Creating test team: 1a8faa59-ea19-42b4-bfd8-0b71d105c216
‚úÖ Created test team: 1a8faa59-ea19-42b4-bfd8-0b71d105c216

‚öîÔ∏è Step 2: Initializing Battle Service...
‚ö†Ô∏è Multi-server coordination unavailable (Redis not in use), using single-server mode.
‚úÖ AI User created: c7046aca-41c4-4458-bd9f-7804171aa9a2

üî• Step 3: Creating Battle...
‚öîÔ∏è Creating 3v3 Battle: {
  user_id: '23182d39-0d3a-4048-895c-861127497dd6',
  user_team_size: 3,
  opponent_id: 'c7046aca-41c4-4458-bd9f-7804171aa9a2',
  opponent_team_size: 3,
  is_pve: true
}
DEBUG: battle_data {
  "user_id": "23182d39-0d3a-4048-895c-861127497dd6",
  "opponent_user_id": null,
  "opponent_ai_coach_id": "c7046aca-41c4-4458-bd9f-7804171aa9a2",
  "user_character_id": null,
  "opponent_character_id": null,
  "opponent_ai_character_id": null,
  "battle_type": "ranked",
  "status": "active",
  "phase": "strategy_select",
  "current_round": 1,
  "max_rounds": 3,
  "user_team_data": {
    "characters": [
      {
        "id": "86f7ccc9-5dd5-4c06-934d-6aa216bffc62",
        "user_id": "23182d39-0d3a-4048-895c-861127497dd6",
        "character_id": "04df39a3-124c-43cc-8cc9-6ca347813eae",
        "serial_number": null,
        "nickname": null,
        "level": 1,
        "experience": 0,
        "bond_level": 0,
        "total_battles": 0,
        "total_wins": 0,
        "current_health": 155,
        "is_injured": false,
        "injury_severity": "healthy",
        "is_dead": false,
        "death_timestamp": null,
        "recovery_time": null,
        "resurrection_available_at": null,
        "death_count": 0,
        "pre_death_level": null,
        "pre_death_experience": null,
        "equipment": [],
        "enhancements": [],
        "conversation_memory": [],
        "significant_memories": [],
        "personality_drift": {},
        "wallet": 0,
        "acquired_at": "2025-12-06T05:28:37.506Z",
        "last_battle_at": null,
        "current_mental_health": 70,
        "current_stress": 50,
        "team_trust": 85,
        "battle_focus": 90,
        "current_training": 60,
        "current_team_player": 55,
        "current_ego": 70,
        "current_communication": 55,
        "current_fatigue": 50,
        "current_morale": 50,
        "starter_gear_given": false,
        "level_bonus_attack": 0,
        "level_bonus_defense": 0,
        "level_bonus_speed": 0,
        "level_bonus_max_health": 0,
        "level_bonus_special": 0,
        "agent_key": null,
        "debt": 0,
        "monthly_earnings": 0,
        "financial_personality": null,
        "recent_decisions": [],
        "sleeping_arrangement": "floor",
        "gameplan_adherence_level": null,
        "current_confidence": 62,
        "skill_points_deprecated": 0,
        "archetype_points_deprecated": 0,
        "species_points_deprecated": 0,
        "signature_points_deprecated": 0,
        "current_energy": 110,
        "current_max_energy": 110,
        "current_mana": 120,
        "current_max_mana": 120,
        "energy_regen_rate": 10,
        "mana_regen_rate": 10,
        "character_points": 0,
        "current_attack": 20,
        "current_defense": 15,
        "current_speed": 20,
        "current_special": 58,
        "current_max_health": 155,
        "equipment_budget": 0,
        "consumables_budget": 0,
        "debt_principal": 0,
        "headquarters_id": null,
        "total_losses": 0,
        "win_percentage": 0,
        "attribute_points": 0,
        "attribute_allocations": {},
        "attribute_pending_survey": null,
        "financial_stress": 10,
        "weight_class": 10,
        "coach_lockout_until": null,
        "current_win_streak": 0,
        "best_win_streak": 0,
        "resource_points": 0,
        "resource_allocations": {},
        "resource_pending_survey": null,
        "coach_trust_level": 20,
        "gameplan_adherence": 32,
        "name": "Test Char",
        "title": null,
        "archetype": null,
        "origin_era": null,
        "rarity": null,
        "max_health": 155,
        "attack": 20,
        "defense": 15,
        "speed": 20,
        "magic_attack": 5,
        "magic_defense": 5,
        "strength": 58,
        "dexterity": 58,
        "intelligence": 62,
        "wisdom": 58,
        "charisma": 62,
        "spirit": 58,
        "critical_chance": 5,
        "critical_damage": 150,
        "accuracy": 85,
        "evasion": 10,
        "max_mana": 120,
        "energy_regen": 10,
        "initiative": 78,
        "personality_traits": [],
        "conversation_style": null,
        "backstory": "Test Backstory",
        "conversation_topics": [],
        "avatar_emoji": null,
        "artwork_url": null,
        "abilities": []
      },
      {
        "id": "3a2d3bc3-425e-4f73-9240-3df10344a5b5",
        "user_id": "23182d39-0d3a-4048-895c-861127497dd6",
        "character_id": "0f068846-693f-4eaa-9106-c570f45b3f9a",
        "serial_number": null,
        "nickname": null,
        "level": 1,
        "experience": 0,
        "bond_level": 0,
        "total_battles": 0,
        "total_wins": 0,
        "current_health": 155,
        "is_injured": false,
        "injury_severity": "healthy",
        "is_dead": false,
        "death_timestamp": null,
        "recovery_time": null,
        "resurrection_available_at": null,
        "death_count": 0,
        "pre_death_level": null,
        "pre_death_experience": null,
        "equipment": [],
        "enhancements": [],
        "conversation_memory": [],
        "significant_memories": [],
        "personality_drift": {},
        "wallet": 0,
        "acquired_at": "2025-12-06T05:28:37.573Z",
        "last_battle_at": null,
        "current_mental_health": 70,
        "current_stress": 50,
        "team_trust": 85,
        "battle_focus": 90,
        "current_training": 60,
        "current_team_player": 55,
        "current_ego": 70,
        "current_communication": 55,
        "current_fatigue": 50,
        "current_morale": 50,
        "starter_gear_given": false,
        "level_bonus_attack": 0,
        "level_bonus_defense": 0,
        "level_bonus_speed": 0,
        "level_bonus_max_health": 0,
        "level_bonus_special": 0,
        "agent_key": null,
        "debt": 0,
        "monthly_earnings": 0,
        "financial_personality": null,
        "recent_decisions": [],
        "sleeping_arrangement": "floor",
        "gameplan_adherence_level": null,
        "current_confidence": 62,
        "skill_points_deprecated": 0,
        "archetype_points_deprecated": 0,
        "species_points_deprecated": 0,
        "signature_points_deprecated": 0,
        "current_energy": 110,
        "current_max_energy": 110,
        "current_mana": 120,
        "current_max_mana": 120,
        "energy_regen_rate": 10,
        "mana_regen_rate": 10,
        "character_points": 0,
        "current_attack": 20,
        "current_defense": 15,
        "current_speed": 20,
        "current_special": 58,
        "current_max_health": 155,
        "equipment_budget": 0,
        "consumables_budget": 0,
        "debt_principal": 0,
        "headquarters_id": null,
        "total_losses": 0,
        "win_percentage": 0,
        "attribute_points": 0,
        "attribute_allocations": {},
        "attribute_pending_survey": null,
        "financial_stress": 10,
        "weight_class": 10,
        "coach_lockout_until": null,
        "current_win_streak": 0,
        "best_win_streak": 0,
        "resource_points": 0,
        "resource_allocations": {},
        "resource_pending_survey": null,
        "coach_trust_level": 20,
        "gameplan_adherence": 32,
        "name": "Test Char",
        "title": null,
        "archetype": null,
        "origin_era": null,
        "rarity": null,
        "max_health": 155,
        "attack": 20,
        "defense": 15,
        "speed": 20,
        "magic_attack": 5,
        "magic_defense": 5,
        "strength": 58,
        "dexterity": 58,
        "intelligence": 62,
        "wisdom": 58,
        "charisma": 62,
        "spirit": 58,
        "critical_chance": 5,
        "critical_damage": 150,
        "accuracy": 85,
        "evasion": 10,
        "max_mana": 120,
        "energy_regen": 10,
        "initiative": 78,
        "personality_traits": [],
        "conversation_style": null,
        "backstory": "Test Backstory",
        "conversation_topics": [],
        "avatar_emoji": null,
        "artwork_url": null,
        "abilities": []
      },
      {
        "id": "31c76e90-5394-482b-ae89-8be425435967",
        "user_id": "23182d39-0d3a-4048-895c-861127497dd6",
        "character_id": "203323c8-7fe1-43aa-8361-9b3021c69be6",
        "serial_number": null,
        "nickname": null,
        "level": 1,
        "experience": 0,
        "bond_level": 0,
        "total_battles": 0,
        "total_wins": 0,
        "current_health": 155,
        "is_injured": false,
        "injury_severity": "healthy",
        "is_dead": false,
        "death_timestamp": null,
        "recovery_time": null,
        "resurrection_available_at": null,
        "death_count": 0,
        "pre_death_level": null,
        "pre_death_experience": null,
        "equipment": [],
        "enhancements": [],
        "conversation_memory": [],
        "significant_memories": [],
        "personality_drift": {},
        "wallet": 0,
        "acquired_at": "2025-12-06T05:28:37.604Z",
        "last_battle_at": null,
        "current_mental_health": 70,
        "current_stress": 50,
        "team_trust": 85,
        "battle_focus": 90,
        "current_training": 60,
        "current_team_player": 55,
        "current_ego": 70,
        "current_communication": 55,
        "current_fatigue": 50,
        "current_morale": 50,
        "starter_gear_given": false,
        "level_bonus_attack": 0,
        "level_bonus_defense": 0,
        "level_bonus_speed": 0,
        "level_bonus_max_health": 0,
        "level_bonus_special": 0,
        "agent_key": null,
        "debt": 0,
        "monthly_earnings": 0,
        "financial_personality": null,
        "recent_decisions": [],
        "sleeping_arrangement": "floor",
        "gameplan_adherence_level": null,
        "current_confidence": 62,
        "skill_points_deprecated": 0,
        "archetype_points_deprecated": 0,
        "species_points_deprecated": 0,
        "signature_points_deprecated": 0,
        "current_energy": 110,
        "current_max_energy": 110,
        "current_mana": 120,
        "current_max_mana": 120,
        "energy_regen_rate": 10,
        "mana_regen_rate": 10,
        "character_points": 0,
        "current_attack": 20,
        "current_defense": 15,
        "current_speed": 20,
        "current_special": 58,
        "current_max_health": 155,
        "equipment_budget": 0,
        "consumables_budget": 0,
        "debt_principal": 0,
        "headquarters_id": null,
        "total_losses": 0,
        "win_percentage": 0,
        "attribute_points": 0,
        "attribute_allocations": {},
        "attribute_pending_survey": null,
        "financial_stress": 10,
        "weight_class": 10,
        "coach_lockout_until": null,
        "current_win_streak": 0,
        "best_win_streak": 0,
        "resource_points": 0,
        "resource_allocations": {},
        "resource_pending_survey": null,
        "coach_trust_level": 20,
        "gameplan_adherence": 32,
        "name": "Test Char",
        "title": null,
        "archetype": null,
        "origin_era": null,
        "rarity": null,
        "max_health": 155,
        "attack": 20,
        "defense": 15,
        "speed": 20,
        "magic_attack": 5,
        "magic_defense": 5,
        "strength": 58,
        "dexterity": 58,
        "intelligence": 62,
        "wisdom": 58,
        "charisma": 62,
        "spirit": 58,
        "critical_chance": 5,
        "critical_damage": 150,
        "accuracy": 85,
        "evasion": 10,
        "max_mana": 120,
        "energy_regen": 10,
        "initiative": 78,
        "personality_traits": [],
        "conversation_style": null,
        "backstory": "Test Backstory",
        "conversation_topics": [],
        "avatar_emoji": null,
        "artwork_url": null,
        "abilities": []
      }
    ]
  },
  "opponent_team_data": {
    "characters": [
      {
        "id": "ai_char_1",
        "name": "AI Grunt 1",
        "current_health": 100,
        "max_health": 100,
        "attack": 10,
        "defense": 5,
        "speed": 10,
        "base_action_points": 3,
        "user_id": "c7046aca-41c4-4458-bd9f-7804171aa9a2"
      },
      {
        "id": "ai_char_2",
        "name": "AI Grunt 2",
        "current_health": 100,
        "max_health": 100,
        "attack": 10,
        "defense": 5,
        "speed": 10,
        "base_action_points": 3,
        "user_id": "c7046aca-41c4-4458-bd9f-7804171aa9a2"
      },
      {
        "id": "ai_char_3",
        "name": "AI Grunt 3",
        "current_health": 100,
        "max_health": 100,
        "attack": 10,
        "defense": 5,
        "speed": 10,
        "base_action_points": 3,
        "user_id": "c7046aca-41c4-4458-bd9f-7804171aa9a2"
      }
    ]
  },
  "battle_log": [],
  "round_results": [],
  "coaching_data": {},
  "ai_judge_context": {},
  "global_morale": {
    "user": 50,
    "opponent": 50
  }
}
Database query error: error: insert or update on table "battles" violates foreign key constraint "battles_opponent_ai_coach_id_fkey"
    at /Users/gabrielgreenstein/Blank_Wars_2026/node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async query (/Users/gabrielgreenstein/Blank_Wars_2026/backend/src/database/postgres.ts:31:20)
    at async Object.create (/Users/gabrielgreenstein/Blank_Wars_2026/backend/src/services/databaseAdapter.ts:1155:9)
    at async BattleManager.create_battle (/Users/gabrielgreenstein/Blank_Wars_2026/backend/src/services/battleService.ts:777:22)
    at async auditBattleSystem (/Users/gabrielgreenstein/Blank_Wars_2026/backend/scripts/audit_battle_system.ts:116:29) {
  length: 329,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (opponent_ai_coach_id)=(c7046aca-41c4-4458-bd9f-7804171aa9a2) is not present in table "ai_coaches".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'battles',
  column: undefined,
  dataType: undefined,
  constraint: 'battles_opponent_ai_coach_id_fkey',
  file: 'ri_triggers.c',
  line: '2607',
  routine: 'ri_ReportViolation'
}
SQL: 
          INSERT INTO battles(
    id, user_id, opponent_user_id,
    opponent_ai_coach_id, opponent_ai_team_id,
    user_character_id, opponent_character_id,
    battle_type, status, phase, current_round, max_rounds,
    user_team_data, opponent_team_data, battle_log, round_results,
    coaching_data, ai_judge_context, global_morale, started_at
  ) VALUES($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, CURRENT_TIMESTAMP)
        
Params: [
  'e1c35280-ad32-4653-8dcb-995115633eae',
  '23182d39-0d3a-4048-895c-861127497dd6',
  null,
  'c7046aca-41c4-4458-bd9f-7804171aa9a2',
  null,
  null,
  null,
  'ranked',
  'active',
  'strategy_select',
  1,
  3,
  '{"characters":[{"id":"86f7ccc9-5dd5-4c06-934d-6aa216bffc62","user_id":"23182d39-0d3a-4048-895c-861127497dd6","character_id":"04df39a3-124c-43cc-8cc9-6ca347813eae","serial_number":null,"nickname":null,"level":1,"experience":0,"bond_level":0,"total_battles":0,"total_wins":0,"current_health":155,"is_injured":false,"injury_severity":"healthy","is_dead":false,"death_timestamp":null,"recovery_time":null,"resurrection_available_at":null,"death_count":0,"pre_death_level":null,"pre_death_experience":null,"equipment":[],"enhancements":[],"conversation_memory":[],"significant_memories":[],"personality_drift":{},"wallet":0,"acquired_at":"2025-12-06T05:28:37.506Z","last_battle_at":null,"current_mental_health":70,"current_stress":50,"team_trust":85,"battle_focus":90,"current_training":60,"current_team_player":55,"current_ego":70,"current_communication":55,"current_fatigue":50,"current_morale":50,"starter_gear_given":false,"level_bonus_attack":0,"level_bonus_defense":0,"level_bonus_speed":0,"level_bonus_max_health":0,"level_bonus_special":0,"agent_key":null,"debt":0,"monthly_earnings":0,"financial_personality":null,"recent_decisions":[],"sleeping_arrangement":"floor","gameplan_adherence_level":null,"current_confidence":62,"skill_points_deprecated":0,"archetype_points_deprecated":0,"species_points_deprecated":0,"signature_points_deprecated":0,"current_energy":110,"current_max_energy":110,"current_mana":120,"current_max_mana":120,"energy_regen_rate":10,"mana_regen_rate":10,"character_points":0,"current_attack":20,"current_defense":15,"current_speed":20,"current_special":58,"current_max_health":155,"equipment_budget":0,"consumables_budget":0,"debt_principal":0,"headquarters_id":null,"total_losses":0,"win_percentage":0,"attribute_points":0,"attribute_allocations":{},"attribute_pending_survey":null,"financial_stress":10,"weight_class":10,"coach_lockout_until":null,"current_win_streak":0,"best_win_streak":0,"resource_points":0,"resource_allocations":{},"resource_pending_survey":null,"coach_trust_level":20,"gameplan_adherence":32,"name":"Test Char","title":null,"archetype":null,"origin_era":null,"rarity":null,"max_health":155,"attack":20,"defense":15,"speed":20,"magic_attack":5,"magic_defense":5,"strength":58,"dexterity":58,"intelligence":62,"wisdom":58,"charisma":62,"spirit":58,"critical_chance":5,"critical_damage":150,"accuracy":85,"evasion":10,"max_mana":120,"energy_regen":10,"initiative":78,"personality_traits":[],"conversation_style":null,"backstory":"Test Backstory","conversation_topics":[],"avatar_emoji":null,"artwork_url":null,"abilities":[]},{"id":"3a2d3bc3-425e-4f73-9240-3df10344a5b5","user_id":"23182d39-0d3a-4048-895c-861127497dd6","character_id":"0f068846-693f-4eaa-9106-c570f45b3f9a","serial_number":null,"nickname":null,"level":1,"experience":0,"bond_level":0,"total_battles":0,"total_wins":0,"current_health":155,"is_injured":false,"injury_severity":"healthy","is_dead":false,"death_timestamp":null,"recovery_time":null,"resurrection_available_at":null,"death_count":0,"pre_death_level":null,"pre_death_experience":null,"equipment":[],"enhancements":[],"conversation_memory":[],"significant_memories":[],"personality_drift":{},"wallet":0,"acquired_at":"2025-12-06T05:28:37.573Z","last_battle_at":null,"current_mental_health":70,"current_stress":50,"team_trust":85,"battle_focus":90,"current_training":60,"current_team_player":55,"current_ego":70,"current_communication":55,"current_fatigue":50,"current_morale":50,"starter_gear_given":false,"level_bonus_attack":0,"level_bonus_defense":0,"level_bonus_speed":0,"level_bonus_max_health":0,"level_bonus_special":0,"agent_key":null,"debt":0,"monthly_earnings":0,"financial_personality":null,"recent_decisions":[],"sleeping_arrangement":"floor","gameplan_adherence_level":null,"current_confidence":62,"skill_points_deprecated":0,"archetype_points_deprecated":0,"species_points_deprecated":0,"signature_points_deprecated":0,"current_energy":110,"current_max_energy":110,"current_mana":120,"current_max_mana":120,"energy_regen_rate":10,"mana_regen_rate":10,"character_points":0,"current_attack":20,"current_defense":15,"current_speed":20,"current_special":58,"current_max_health":155,"equipment_budget":0,"consumables_budget":0,"debt_principal":0,"headquarters_id":null,"total_losses":0,"win_percentage":0,"attribute_points":0,"attribute_allocations":{},"attribute_pending_survey":null,"financial_stress":10,"weight_class":10,"coach_lockout_until":null,"current_win_streak":0,"best_win_streak":0,"resource_points":0,"resource_allocations":{},"resource_pending_survey":null,"coach_trust_level":20,"gameplan_adherence":32,"name":"Test Char","title":null,"archetype":null,"origin_era":null,"rarity":null,"max_health":155,"attack":20,"defense":15,"speed":20,"magic_attack":5,"magic_defense":5,"strength":58,"dexterity":58,"intelligence":62,"wisdom":58,"charisma":62,"spirit":58,"critical_chance":5,"critical_damage":150,"accuracy":85,"evasion":10,"max_mana":120,"energy_regen":10,"initiative":78,"personality_traits":[],"conversation_style":null,"backstory":"Test Backstory","conversation_topics":[],"avatar_emoji":null,"artwork_url":null,"abilities":[]},{"id":"31c76e90-5394-482b-ae89-8be425435967","user_id":"23182d39-0d3a-4048-895c-861127497dd6","character_id":"203323c8-7fe1-43aa-8361-9b3021c69be6","serial_number":null,"nickname":null,"level":1,"experience":0,"bond_level":0,"total_battles":0,"total_wins":0,"current_health":155,"is_injured":false,"injury_severity":"healthy","is_dead":false,"death_timestamp":null,"recovery_time":null,"resurrection_available_at":null,"death_count":0,"pre_death_level":null,"pre_death_experience":null,"equipment":[],"enhancements":[],"conversation_memory":[],"significant_memories":[],"personality_drift":{},"wallet":0,"acquired_at":"2025-12-06T05:28:37.604Z","last_battle_at":null,"current_mental_health":70,"current_stress":50,"team_trust":85,"battle_focus":90,"current_training":60,"current_team_player":55,"current_ego":70,"current_communication":55,"current_fatigue":50,"current_morale":50,"starter_gear_given":false,"level_bonus_attack":0,"level_bonus_defense":0,"level_bonus_speed":0,"level_bonus_max_health":0,"level_bonus_special":0,"agent_key":null,"debt":0,"monthly_earnings":0,"financial_personality":null,"recent_decisions":[],"sleeping_arrangement":"floor","gameplan_adherence_level":null,"current_confidence":62,"skill_points_deprecated":0,"archetype_points_deprecated":0,"species_points_deprecated":0,"signature_points_deprecated":0,"current_energy":110,"current_max_energy":110,"current_mana":120,"current_max_mana":120,"energy_regen_rate":10,"mana_regen_rate":10,"character_points":0,"current_attack":20,"current_defense":15,"current_speed":20,"current_special":58,"current_max_health":155,"equipment_budget":0,"consumables_budget":0,"debt_principal":0,"headquarters_id":null,"total_losses":0,"win_percentage":0,"attribute_points":0,"attribute_allocations":{},"attribute_pending_survey":null,"financial_stress":10,"weight_class":10,"coach_lockout_until":null,"current_win_streak":0,"best_win_streak":0,"resource_points":0,"resource_allocations":{},"resource_pending_survey":null,"coach_trust_level":20,"gameplan_adherence":32,"name":"Test Char","title":null,"archetype":null,"origin_era":null,"rarity":null,"max_health":155,"attack":20,"defense":15,"speed":20,"magic_attack":5,"magic_defense":5,"strength":58,"dexterity":58,"intelligence":62,"wisdom":58,"charisma":62,"spirit":58,"critical_chance":5,"critical_damage":150,"accuracy":85,"evasion":10,"max_mana":120,"energy_regen":10,"initiative":78,"personality_traits":[],"conversation_style":null,"backstory":"Test Backstory","conversation_topics":[],"avatar_emoji":null,"artwork_url":null,"abilities":[]}]}',
  '{"characters":[{"id":"ai_char_1","name":"AI Grunt 1","current_health":100,"max_health":100,"attack":10,"defense":5,"speed":10,"base_action_points":3,"user_id":"c7046aca-41c4-4458-bd9f-7804171aa9a2"},{"id":"ai_char_2","name":"AI Grunt 2","current_health":100,"max_health":100,"attack":10,"defense":5,"speed":10,"base_action_points":3,"user_id":"c7046aca-41c4-4458-bd9f-7804171aa9a2"},{"id":"ai_char_3","name":"AI Grunt 3","current_health":100,"max_health":100,"attack":10,"defense":5,"speed":10,"base_action_points":3,"user_id":"c7046aca-41c4-4458-bd9f-7804171aa9a2"}]}',
  '[]',
  '[]',
  '{}',
  '{}',
  '{"user":50,"opponent":50}'
]
Error creating battle: error: insert or update on table "battles" violates foreign key constraint "battles_opponent_ai_coach_id_fkey"
    at /Users/gabrielgreenstein/Blank_Wars_2026/node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async query (/Users/gabrielgreenstein/Blank_Wars_2026/backend/src/database/postgres.ts:31:20)
    at async Object.create (/Users/gabrielgreenstein/Blank_Wars_2026/backend/src/services/databaseAdapter.ts:1155:9)
    at async BattleManager.create_battle (/Users/gabrielgreenstein/Blank_Wars_2026/backend/src/services/battleService.ts:777:22)
    at async auditBattleSystem (/Users/gabrielgreenstein/Blank_Wars_2026/backend/scripts/audit_battle_system.ts:116:29) {
  length: 329,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (opponent_ai_coach_id)=(c7046aca-41c4-4458-bd9f-7804171aa9a2) is not present in table "ai_coaches".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'battles',
  column: undefined,
  dataType: undefined,
  constraint: 'battles_opponent_ai_coach_id_fkey',
  file: 'ri_triggers.c',
  line: '2607',
  routine: 'ri_ReportViolation'
}
Error creating battle: Error: Failed to create battle in database
    at BattleManager.create_battle (/Users/gabrielgreenstein/Blank_Wars_2026/backend/src/services/battleService.ts:779:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async auditBattleSystem (/Users/gabrielgreenstein/Blank_Wars_2026/backend/scripts/audit_battle_system.ts:116:29)
‚ùå Audit Failed: Error: Battle creation failed
    at auditBattleSystem (/Users/gabrielgreenstein/Blank_Wars_2026/backend/scripts/audit_battle_system.ts:118:33)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)

üìä Final Audit Results: { Setup: true, Overall_Success: false }
