name: GPT Change via Issue Comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read
  models: read

jobs:
  handle_command:
    if: startsWith(github.event.comment.body, '/gpt:') &&
        (github.event.comment.author_association == 'OWNER' ||
         github.event.comment.author_association == 'MEMBER' ||
         github.event.comment.author_association == 'COLLABORATOR')
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Parse command
        id: parse
        run: |
          BODY="${{ github.event.comment.body }}"
          TASK="${BODY#"/gpt:"}"
          TASK="${TASK#" "}"
          echo "task<<EOF" >> $GITHUB_OUTPUT
          echo "$TASK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Ensure gh + gh-models
        env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: |
          gh --version
          gh extension install https://github.com/github/gh-models || true

      - name: Generate patch with GPT-5
        id: gen
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL_ID: openai/gpt-5
        run: |
          python3 tools/generate_patch.py <<'EOF' > patch.diff
          ${{ steps.parse.outputs.task }}
          EOF
          head -n 60 patch.diff || true

      - name: Create branch from DEFAULT and apply patch  # <- SAFE
        run: |
          set -e
          git fetch origin --prune
          BASE="${{ github.event.repository.default_branch }}"
          BRANCH="gpt/${{ github.run_id }}"
          git checkout -B "$BRANCH" "origin/$BASE"
          git apply -3 --whitespace=fix patch.diff

      - name: Build/Test (best-effort)
        run: |
          if [ -f package.json ]; then
            if command -v pnpm >/dev/null; then PKG=pnpm; else PKG=npm; fi
            $PKG install || true
            node -e "p=require('./package.json');process.exit(p.scripts?.test?0:1)" && $PKG test || true
            node -e "p=require('./package.json');process.exit(p.scripts?.build?0:1)" && $PKG run build || true
          elif compgen -G "*.py" >/dev/null; then
            command -v pytest >/dev/null && pytest -q || true
          fi

      - name: Commit & push
        run: |
          git add -A
          git commit -m "gpt: ${{ steps.parse.outputs.task }}" || echo "No changes to commit"
          git push -u origin HEAD

      - name: Open PR
        env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: |
          BASE="${{ github.event.repository.default_branch }}"
          gh pr create --base "$BASE" --title "gpt: ${{ steps.parse.outputs.task }}" --body "Generated by GPT-5 via issue comment"