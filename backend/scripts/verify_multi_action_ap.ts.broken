/**
 * Comprehensive Multi-Action AP Test
 * 
 * Tests 3v3 battles with 3 AP per turn, verifying:
 * - Multiple actions per turn
 * - Different attack types (jab, strike, heavy)
 * - AP validation and deduction
 * - Turn combinations
 * 
 * AP Costs:
 * - Jab: 1 AP (0.5x damage)
 * - Strike: 2 AP (1.0x damage)  
 * - Heavy: 3 AP (1.75x damage)
 * - Move: 1 AP
 * - Defend: 1 AP
 * - Powers/Spells: Rank-based (1-3 AP)
 */

import 'dotenv/config';
import { query } from '../database';

const MAX_AP_PER_TURN = 3;

interface TestResult {
    name: string;
    passed: boolean;
    details: string;
}

async function runMultiActionAPTest(): Promise<void> {
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üéØ MULTI-ACTION AP SYSTEM TEST');
    console.log('   Testing 3 AP per turn with various action combinations');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    const results: TestResult[] = [];

    // =============================================
    // TEST 1: Verify Attack Type AP Costs in DB
    // =============================================
    console.log('üìã TEST 1: Verify Attack Types...');
    try {
      SELECT id, name, ap_cost, damage_multiplier 
      FROM action_types 
      ORDER BY ap_cost
            `);

        console.log('   Attack Types from DB:');
        for (const row of attack_types.rows) {
            console.log(`   - ${ row.id }: ${ row.ap_cost } AP, ${ row.damage_multiplier }x damage`);
        }

        const jab = attack_types.rows.find((r: any) => r.id === 'jab');
        const strike = attack_types.rows.find((r: any) => r.id === 'strike');
        const heavy = attack_types.rows.find((r: any) => r.id === 'heavy');

        const attacks_valid =
            jab?.ap_cost === 1 &&
            strike?.ap_cost === 2 &&
            heavy?.ap_cost === 3;

        results.push({
            name: 'Attack Type AP Costs',
            passed: attacks_valid,
            details: attacks_valid
                ? 'jab=1AP, strike=2AP, heavy=3AP ‚úì'
                : `Expected jab = 1, strike = 2, heavy = 3. Got: jab = ${ jab?.ap_cost }, strike = ${ strike?.ap_cost }, heavy = ${ heavy?.ap_cost } `
        });
        console.log(attacks_valid ? '   ‚úÖ Attack types verified\n' : '   ‚ùå Attack types incorrect\n');

    } catch (error: any) {
        results.push({
            name: 'Attack Type AP Costs',
            passed: false,
            details: `Error: ${ error.message } `
        });
        console.log(`   ‚ùå Error: ${ error.message } \n`);
    }

    // =============================================
    // TEST 2: Verify AP Combinations (3 jabs = 3 AP)
    // =============================================
    console.log('üìã TEST 2: Verify AP Combinations...');
    const combinations = [
        { actions: ['jab', 'jab', 'jab'], total_ap: 3, valid: true, desc: '3 jabs (1+1+1=3 AP)' },
        { actions: ['jab', 'strike'], total_ap: 3, valid: true, desc: 'jab + strike (1+2=3 AP)' },
        { actions: ['strike', 'jab'], total_ap: 3, valid: true, desc: 'strike + jab (2+1=3 AP)' },
        { actions: ['heavy'], total_ap: 3, valid: true, desc: 'heavy only (3 AP)' },
        { actions: ['jab', 'jab'], total_ap: 2, valid: true, desc: '2 jabs (1+1=2 AP, 1 leftover)' },
        { actions: ['strike', 'strike'], total_ap: 4, valid: false, desc: '2 strikes (2+2=4 AP) - INVALID' },
        { actions: ['heavy', 'jab'], total_ap: 4, valid: false, desc: 'heavy + jab (3+1=4 AP) - INVALID' },
    ];

    for (const combo of combinations) {
        const can_execute = combo.total_ap <= MAX_AP_PER_TURN;
        const combo_correct = can_execute === combo.valid;
        console.log(`   ${ combo_correct ? '‚úì' : '‚úó' } ${ combo.desc }: ${ can_execute ? 'CAN' : 'CANNOT' } execute`);
    }

    results.push({
        name: 'AP Combinations Logic',
        passed: true,
        details: `Tested ${ combinations.length } combinations with 3 AP max`
    });
    console.log('   ‚úÖ AP combination logic verified\n');

    // =============================================
    // TEST 3: Test Actual Battle Turn with Multi-Actions
    // =============================================
    console.log('üìã TEST 3: Create Battle and Test Multi-Action Turn...');

    let test_battle_id: string | null = null;

    try {
        // Get two real users with teams
        const users = await query(`
      SELECT DISTINCT u.id as user_id
      FROM users u
      JOIN teams t ON t.user_id = u.id
      WHERE t.is_active = true 
      AND u.id != '00000000-0000-0000-0000-000000000001'
      LIMIT 2
    `);

        if (users.rows.length < 2) {
            throw new Error('Need at least 2 users with active teams');
        }

        const user_a_id = users.rows[0].user_id;
        const user_b_id = users.rows[1].user_id;

        console.log(`   User A: ${ user_a_id } `);
        console.log(`   User B: ${ user_b_id } `);

        // Get team A characters
        const team_a = await query(`
      SELECT uc.id, uc.character_id, c.name, uc.current_attack, uc.current_defense, uc.current_health
      FROM teams t
      JOIN user_characters uc ON uc.id IN(TRIM(t.character_slot_1), TRIM(t.character_slot_2), TRIM(t.character_slot_3))
      JOIN characters c ON uc.character_id = c.id
      WHERE t.user_id = $1 AND t.is_active = true
      ORDER BY uc.id
      LIMIT 3
            `, [user_a_id]);

        // Get team B characters
        const team_b = await query(`
      SELECT uc.id, uc.character_id, c.name, uc.current_attack, uc.current_defense, uc.current_health
      FROM teams t
      JOIN user_characters uc ON uc.id IN(t.character_slot_1, t.character_slot_2, t.character_slot_3)
      JOIN characters c ON uc.character_id = c.id
      WHERE t.user_id = $1 AND t.is_active = true
      ORDER BY uc.id
      LIMIT 3
    `, [user_b_id]);

        console.log(`   Team A: ${ team_a.rows.map((r: any) => r.name).join(', ') } `);
        console.log(`   Team B: ${ team_b.rows.map((r: any) => r.name).join(', ') } `);

        // Create test battle
        const battle_result = await query(`
      INSERT INTO battles(id, user_id, opponent_user_id, status, judge_id)
        VALUES(gen_random_uuid():: text, $1, $2, 'active', 'king_solomon')
      RETURNING id
    `, [user_a_id, user_b_id]);

        test_battle_id = battle_result.rows[0].id;
        console.log(`   Created battle: ${ test_battle_id } `);

        results.push({
            name: 'Battle Creation',
            passed: true,
            details: `Battle ${ test_battle_id } created with 3v3 teams`
        });

        // =============================================
        // TEST 4: Verify AP Tracking in Battle Actions Table
        // =============================================
        console.log('\nüìã TEST 4: Record Multi-Action Turn...');

        const char = team_a.rows[0];
        const target = team_b.rows[0];
        const turn_number = 1;

        // Simulate recording 3 jabs (3 AP spent)
        for (let action_num = 1; action_num <= 3; action_num++) {
            await query(`
        INSERT INTO battle_actions(
            battle_id, character_id, action_type, request,
            result, sequence_num, round_num, turn_num
        ) VALUES($1, $2, $3, $4, $5, $6, $7, $8)
      `, [
                test_battle_id,
                char.id,
                'attack',
                JSON.stringify({
                    target_id: target.id,
                    attack_type_id: 'jab'
                }),
                JSON.stringify({
                    success: true,
                    attack_type_id: 'jab',
                    ap_cost: 1,
                    damage_dealt: 5,
                    action_type: 'attack',
                    narrative: `${ char.name } jabs ${ target.name } !`
                }),
                action_num, // sequence_num
                1,          // round_num
                turn_number // turn_num
            ]);
        }

        // Verify actions recorded
        const actions = await query(`
        SELECT * FROM battle_actions 
      WHERE battle_id = $1 AND character_id = $2
      ORDER BY sequence_num
    `, [test_battle_id, char.id]);

        const total_ap_spent = actions.rows.reduce((sum: number, a: any) => {
            const result = typeof a.result === 'string' ? JSON.parse(a.result) : a.result;
            return sum + (result.ap_cost || 0);
        }, 0);

        console.log(`   Recorded ${ actions.rows.length } actions for ${ char.name }`);
        console.log(`   Total AP spent: ${ total_ap_spent } `);

        results.push({
            name: 'Multi-Action Recording',
            passed: actions.rows.length === 3 && total_ap_spent === 3,
            details: `${ actions.rows.length } actions recorded, ${ total_ap_spent } AP spent`
        });

        console.log(actions.rows.length === 3 ? '   ‚úÖ Multi-action turn recorded\n' : '   ‚ùå Recording failed\n');

        // =============================================  
        // TEST 5: Test Mixed Action Turn (strike + defend)
        // =============================================
        console.log('üìã TEST 5: Mixed Action Turn (strike + defend = 3AP)...');

        const char2 = team_a.rows[1];
        const turn_number_2 = 2;

        // Strike (2 AP)
        await query(`
      INSERT INTO battle_actions(
            battle_id, character_id, action_type, request,
            result, sequence_num, round_num, turn_num
        ) VALUES($1, $2, $3, $4, $5, $6, $7, $8)
    `, [
            test_battle_id,
            char2.id,
            'attack',
            JSON.stringify({
                target_id: target.id,
                attack_type_id: 'strike'
            }),
            JSON.stringify({
                success: true,
                attack_type_id: 'strike',
                ap_cost: 2,
                damage_dealt: 10,
                action_type: 'attack',
                narrative: `${ char2.name } strikes ${ target.name } !`
            }),
            4, // sequence_num (continued)
            1,
            turn_number_2
        ]);

        // Defend (1 AP)
        await query(`
      INSERT INTO battle_actions(
            battle_id, character_id, action_type, request,
            result, sequence_num, round_num, turn_num
        ) VALUES($1, $2, $3, $4, $5, $6, $7, $8)
    `, [
            test_battle_id,
            char2.id,
            'defend',
            JSON.stringify({}),
            JSON.stringify({
                success: true,
                ap_cost: 1,
                action_type: 'defend',
                narrative: `${ char2.name } takes a defensive stance!`
            }),
            5,
            1,
            turn_number_2
        ]);

        const mixed_actions = await query(`
        SELECT * FROM battle_actions 
      WHERE battle_id = $1 AND character_id = $2 AND turn_num = $3
      ORDER BY sequence_num
    `, [test_battle_id, char2.id, turn_number_2]);

        const mixed_ap = mixed_actions.rows.reduce((sum: number, a: any) => {
            const result = typeof a.result === 'string' ? JSON.parse(a.result) : a.result;
            return sum + (result.ap_cost || 0);
        }, 0);

        console.log(`   ${ char2.name }: strike(2 AP) + defend(1 AP) = ${ mixed_ap } AP`);

        results.push({
            name: 'Mixed Action Turn (strike + defend)',
            passed: mixed_actions.rows.length === 2 && mixed_ap === 3,
            details: `2 actions, ${ mixed_ap } AP total`
        });

        console.log(mixed_ap === 3 ? '   ‚úÖ Mixed action turn verified\n' : '   ‚ùå Mixed action failed\n');

        // =============================================
        // TEST 6: Heavy Attack (uses all 3 AP)
        // =============================================
        console.log('üìã TEST 6: Heavy Attack (3 AP, uses entire turn)...');

        const char3 = team_a.rows[2] || team_a.rows[0];
        const turn_number_3 = 3;

        await query(`
      INSERT INTO battle_actions(
            battle_id, character_id, action_type, request,
            result, sequence_num, round_num, turn_num
        ) VALUES($1, $2, $3, $4, $5, $6, $7, $8)
    `, [
            test_battle_id,
            char3.id,
            'attack',
            JSON.stringify({
                target_id: target.id,
                attack_type_id: 'heavy'
            }),
            JSON.stringify({
                success: true,
                attack_type_id: 'heavy',
                ap_cost: 3,
                damage_dealt: 18,
                damage_multiplier: 1.75,
                action_type: 'attack',
                narrative: `${ char3.name } delivers a devastating heavy attack to ${ target.name } !`
            }),
            6,
            1,
            turn_number_3
        ]);

        const heavy_action = await query(`
        SELECT * FROM battle_actions 
      WHERE battle_id = $1 AND character_id = $2 AND turn_num = $3
            `, [test_battle_id, char3.id, turn_number_3]);

        const heavy_result = typeof heavy_action.rows[0]?.result === 'string'
            ? JSON.parse(heavy_action.rows[0].result)
            : heavy_action.rows[0]?.result;

        console.log(`   ${ char3.name }: heavy attack = ${ heavy_result?.ap_cost } AP`);
        console.log(`   Damage dealt: ${ heavy_result?.damage_dealt } (1.75x multiplier)`);

        results.push({
            name: 'Heavy Attack (3 AP)',
            passed: heavy_result?.ap_cost === 3,
            details: `Heavy attack used ${ heavy_result?.ap_cost } AP, dealt ${ heavy_result?.damage_dealt } damage`
        });

        console.log(heavy_result?.ap_cost === 3 ? '   ‚úÖ Heavy attack verified\n' : '   ‚ùå Heavy attack failed\n');

    } catch (error: any) {
        results.push({
            name: 'Battle Multi-Action Test',
            passed: false,
            details: `Error: ${ error.message } `
        });
        console.log(`   ‚ùå Error: ${ error.message } \n`);
    }

    // =============================================
    // CLEANUP
    // =============================================
    if (test_battle_id) {
        console.log('üßπ Cleaning up test data...');
        await query('DELETE FROM battle_actions WHERE battle_id = $1', [test_battle_id]);
        await query('DELETE FROM battles WHERE id = $1', [test_battle_id]);
        console.log('   ‚úÖ Cleanup complete\n');
    }

    // =============================================
    // SUMMARY
    // =============================================
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üìä TEST RESULTS SUMMARY');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

    const passed = results.filter(r => r.passed).length;
    const failed = results.filter(r => !r.passed).length;

    for (const result of results) {
        console.log(`   ${ result.passed ? '‚úÖ' : '‚ùå' } ${ result.name }: ${ result.details } `);
    }

    console.log('');
    console.log(`   ‚úÖ Passed: ${ passed } `);
    console.log(`   ‚ùå Failed: ${ failed } `);
    console.log('');

    if (failed === 0) {
        console.log('üéâ ALL TESTS PASSED!');
    } else {
        console.log('‚ö†Ô∏è SOME TESTS FAILED');
    }
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

    process.exit(failed > 0 ? 1 : 0);
}

runMultiActionAPTest().catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
});
